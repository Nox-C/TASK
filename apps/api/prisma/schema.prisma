// prisma/schema.prisma
// Define your database models

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String?
  passwordHash String?
  createdAt    DateTime  @default(now())
  sessions     Session[]
  bots         Bot[]
  accounts     Account[]
  tasks        Task[]
}

model Session {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  expires   DateTime
  createdAt DateTime @default(now())
}

model Strategy {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  bots        Bot[]
}

model Bot {
  id          String   @id @default(uuid())
  name        String
  owner       User     @relation(fields: [ownerId], references: [id])
  ownerId     String
  strategy    Strategy @relation(fields: [strategyId], references: [id])
  strategyId  String
  active      Boolean  @default(false)
  createdAt   DateTime @default(now())
  runs        BotRun[]
}

model BotRun {
  id        String   @id @default(uuid())
  bot       Bot      @relation(fields: [botId], references: [id])
  botId     String
  startedAt DateTime @default(now())
  stoppedAt DateTime?
  status    String
}

model Account {
  id        String   @id @default(uuid())
  owner     User     @relation(fields: [ownerId], references: [id])
  ownerId   String
  name      String
  isBacktest Boolean @default(false)
  createdAt DateTime @default(now())
  balances  Balance[]
  positions Position[]
  orders    Order[]
  ledgerEntries LedgerEntry[]
  pnlSnapshots PnlSnapshot[]
}

model Balance {
  id        String  @id @default(uuid())
  account   Account @relation(fields: [accountId], references: [id])
  accountId String
  asset     String
  amount    Float   @default(0)
}

model Position {
  id        String  @id @default(uuid())
  account   Account @relation(fields: [accountId], references: [id])
  accountId String
  symbol    String
  qty       Float   @default(0)
  avgPrice  Float   @default(0)
}

model Order {
  id         String   @id @default(uuid())
  account    Account  @relation(fields: [accountId], references: [id])
  accountId  String
  symbol     String
  side       String
  qty        Float
  price      Float?
  status     String
  createdAt  DateTime @default(now())
  fills      Fill[]
}

model Fill {
  id           String   @id @default(uuid())
  order        Order    @relation(fields: [orderId], references: [id])
  orderId      String
  qty          Decimal  @db.Decimal(30, 10)
  price        Decimal  @db.Decimal(30, 10)
  executedQty  Decimal  @db.Decimal(30, 10)
  executedPrice Decimal @db.Decimal(30, 10)
  feeAmount    Decimal? @db.Decimal(30, 10)
  feeAsset     String?
  feeDetails   Json?
  createdAt    DateTime @default(now())
}

model PriceTick {
  id        String   @id @default(uuid())
  symbol    String
  price     Decimal  @db.Decimal(30, 10)
  bid       Decimal? @db.Decimal(30, 10)
  ask       Decimal? @db.Decimal(30, 10)
  source    String?
  ts        DateTime
  createdAt DateTime @default(now())
}

model LedgerEntry {
  id           String   @id @default(uuid())
  account      Account  @relation(fields: [accountId], references: [id])
  accountId    String
  asset        String
  debit        Decimal  @db.Decimal(30, 10) @default("0")
  credit       Decimal  @db.Decimal(30, 10) @default("0")
  currency     String   @default("USD")
  referenceType String?
  referenceId  String?
  meta         Json?
  createdAt    DateTime @default(now())
}

model PnlSnapshot {
  id           String   @id @default(uuid())
  account      Account  @relation(fields: [accountId], references: [id])
  accountId    String
  realizedPnl  Decimal  @db.Decimal(30, 10) @default("0")
  unrealizedPnl Decimal @db.Decimal(30, 10) @default("0")
  totalValue   Decimal  @db.Decimal(30, 10) @default("0")
  details      Json?
  createdAt    DateTime @default(now())
}

model BacktestRun {
  id               String   @id @default(uuid())
  name             String?
  sourceAccountId  String?
  backtestAccountId String?
  params           Json
  report           Json?
  status           String   @default("pending")
  createdAt        DateTime @default(now())
}

model Task {
  id         String       @id @default(uuid())
  name       String
  owner      User         @relation(fields: [ownerId], references: [id])
  ownerId    String
  triggers   TaskTrigger[]
  actions    TaskAction[]
  runs       TaskRun[]
  createdAt  DateTime     @default(now())
}

model TaskRun {
  id        String    @id @default(uuid())
  task      Task      @relation(fields: [taskId], references: [id])
  taskId    String
  status    String
  startedAt DateTime  @default(now())
  finishedAt DateTime?
}

model TaskTrigger {
  id        String   @id @default(uuid())
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    String
  type      String
  config    Json
}

model TaskAction {
  id        String   @id @default(uuid())
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    String
  type      String
  config    Json
}

model AuditEvent {
  id        String   @id @default(uuid())
  actorId   String?
  actorType String?
  action    String
  details   Json?
  createdAt DateTime @default(now())
}
